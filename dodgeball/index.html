<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Dodgeball</title>
    <style>
    * {
        padding: 0;
        margin: 0;
    }
    canvas {
        background: #000;
        display: block;
        margin: 0 auto;
    }
    body {
        font-family: monospace;
    }
    h1, p {
        text-align: center;
        padding: 30px;
    }
    </style>
</head>
<body>

<h1>DodgeBall</h1>

<canvas id="canvas" width="480" height="320"></canvas>

<p>Level: <span id="level">1</span></p>

<script>

var Dodgeball = (function() {

    var canvas = document.getElementById('canvas');
    var c = canvas.getContext('2d');

    var level = document.getElementById('level');

    var upPressed = false;
    var downPressed = false;
    var rightPressed = false;
    var leftPressed = false;

    var keys = {
        left  : 37,
        up    : 38,
        right : 39,
        down  : 40
    };

    // ball
    var ball = {
        yPos   : canvas.height - (100),
        xPos   : canvas.width / 2,
        colour : 'cyan',
        radius : 10,
        dirX   : 1.5,
        dirY   : 1.5,
        speed  : 1
    };

    // user
    var user = {
        yPos        : 100,
        xPos        : canvas.width / 2,
        colour      : 'red',
        width       : 20,
        height      : 20,
        sensitivity : 2,
        level       : 1
    };

    function init() {

        window.requestAnimationFrame(draw);
        events();

        // change level
        setInterval(function() {
            ball.speed = ball.speed + 0.5;
            user.level += 1;
            level.innerHTML = user.level;
        }, 3000);

    }

    function events() {

        document.addEventListener('keydown', keyDownHandler, false);
        document.addEventListener('keyup', keyUpHandler, false);

    }

    function keyDownHandler(e) {

        if ( e.keyCode == keys.up ) {
            upPressed = true;
        }

        if ( e.keyCode == keys.down ) {
            downPressed = true;
        }

        if ( e.keyCode == keys.right ) {
            rightPressed = true;
        }

        if ( e.keyCode == keys.left ) {
            leftPressed = true;
        }

    }

    function keyUpHandler(e) {

        if ( e.keyCode == keys.up ) {
            upPressed = false;
        }

        if ( e.keyCode == keys.down ) {
            downPressed = false;
        }

        if ( e.keyCode == keys.right ) {
            rightPressed = false;
        }

        if ( e.keyCode == keys.left ) {
            leftPressed = false;
        }

    }

    function drawUser() {

        c.beginPath();
        c.rect( user.xPos, user.yPos, user.width, user.height);
        c.fillStyle = user.colour;
        c.fill();
        c.closePath();

    }

    function drawBall() {

        c.beginPath();
        c.arc( ball.xPos, ball.yPos, ball.radius, 0, Math.PI * 2 );
        c.fillStyle = ball.colour;
        c.fill();

    }

    function looseGame() {
        alert('Hit! Sorry, you loose.');
        window.location.reload();
    }

    function draw() {

        var ballHitRight  = ball.xPos + ball.radius > canvas.width;
        var ballHitLeft   = ball.xPos < ball.radius;
        var ballHitBottom = ball.yPos + ball.radius > canvas.height;
        var ballHitTop    = ball.yPos < ball.radius;

        c.clearRect( 0, 0, canvas.width, canvas.height );

        // ball's direction
        if ( ballHitRight || ballHitLeft ) {
            ball.dirX = -ball.dirX;
        }

        if ( ballHitBottom || ballHitTop ) {
            ball.dirY = -ball.dirY;
        }

        // ball's speed
        ball.xPos += (ball.dirX * ball.speed);
        ball.yPos += (ball.dirY * ball.speed);

        // user's position
        if ( upPressed ) {
            user.yPos = user.yPos - user.sensitivity;
        }
        if ( downPressed ) {
            user.yPos = user.yPos + user.sensitivity;
        }
        if ( leftPressed ) {
            user.xPos = user.xPos - user.sensitivity;
        }
        if ( rightPressed ) {
            user.xPos = user.xPos + user.sensitivity;
        }

        // collision detection

        var ballXPos = Math.floor(ball.xPos);
        var ballYPos = Math.floor(ball.yPos);
        var userXPos = Math.floor(user.xPos);
        var userYPos = Math.floor(user.yPos);

        var collideOnXAxis = (userXPos + user.width ) > (ballXPos - ball.radius) && (userXPos < (ballXPos + ball.radius));
        var collideOnYAxis = (userYPos + user.width ) > (ballYPos - ball.radius) && (userYPos < (ballYPos + ball.radius));

        if ( collideOnYAxis && collideOnXAxis ) {
            looseGame();
        }

        drawUser();
        drawBall();

        window.requestAnimationFrame(draw);

    }

    init();

})();
</script>

</body>
</html>